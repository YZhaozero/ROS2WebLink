<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>机器人导航状态监控</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .header {
      background-color: #2c3e50;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .panel {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .full-width {
      grid-column: 1 / -1;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-idle { background-color: #95a5a6; }
    .status-going { background-color: #f39c12; }
    .status-paused { background-color: #e67e22; }
    .status-succeeded { background-color: #27ae60; }
    .status-failed { background-color: #e74c3c; }
    .map-container {
      border: 2px solid #34495e;
      border-radius: 8px;
      overflow: hidden;
    }
    canvas {
      display: block;
      cursor: crosshair;
    }
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .status-item {
      padding: 10px;
      background-color: #ecf0f1;
      border-radius: 4px;
      border-left: 4px solid #3498db;
    }
    .status-item h4 {
      margin: 0 0 5px 0;
      color: #2c3e50;
    }
    .status-item .value {
      font-size: 18px;
      font-weight: bold;
      color: #3498db;
    }
    .navigation-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .history-log {
      max-height: 300px;
      overflow-y: auto;
      background-color: #2c3e50;
      color: #ecf0f1;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin-bottom: 5px;
      padding: 2px 0;
    }
    .log-timestamp {
      color: #95a5a6;
      margin-right: 10px;
    }
    .input-group {
      margin: 10px 0;
      padding: 15px;
      background-color: #ecf0f1;
      border-radius: 4px;
    }
    .input-group label {
      display: inline-block;
      width: 80px;
      margin-right: 10px;
      font-weight: bold;
    }
    .input-group input {
      padding: 8px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      margin-right: 10px;
      width: 100px;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #ecf0f1;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background-color: #3498db;
      transition: width 0.3s ease;
    }
    .alert {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🤖 机器人导航状态监控系统</h1>
    <p>实时监控机器人导航状态、位置信息和任务执行情况</p>
  </div>

  <div class="container">
    <!-- 导航状态面板 -->
    <div class="panel">
      <h3>🧭 导航状态</h3>
      <div class="status-grid">
        <div class="status-item">
          <h4>当前状态</h4>
          <div class="value">
            <span class="status-indicator status-idle" id="statusIndicator"></span>
            <span id="navigationStatus">IDLE</span>
          </div>
        </div>
        <div class="status-item">
          <h4>电池电量</h4>
          <div class="value" id="batteryLevel">85%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="batteryProgress" style="width: 85%"></div>
          </div>
        </div>
        <div class="status-item">
          <h4>X坐标</h4>
          <div class="value" id="positionX">0.00</div>
        </div>
        <div class="status-item">
          <h4>Y坐标</h4>
          <div class="value" id="positionY">0.00</div>
        </div>
        <div class="status-item">
          <h4>朝向角度</h4>
          <div class="value" id="positionTheta">0.00°</div>
        </div>
        <div class="status-item">
          <h4>定位精度</h4>
          <div class="value" id="localizationReliability">95%</div>
        </div>
      </div>
      
      <div class="navigation-controls">
        <button onclick="startAutoUpdate()">🔄 开始监控</button>
        <button onclick="stopAutoUpdate()">⏹️ 停止监控</button>
        <button onclick="pauseNavigation()" id="pauseBtn">⏸️ 暂停导航</button>
        <button onclick="resumeNavigation()" id="resumeBtn">▶️ 恢复导航</button>
        <button onclick="emergencyStop()">🚨 紧急停止</button>
      </div>
      
      <div id="alertContainer"></div>
    </div>

    <!-- 导航控制面板 -->
    <div class="panel">
      <h3>🎯 导航控制</h3>
      
      <div class="input-group">
        <h4>设置导航目标</h4>
        <label>X坐标:</label>
        <input type="number" id="goalX" step="0.1" value="5.0">
        <label>Y坐标:</label>
        <input type="number" id="goalY" step="0.1" value="3.0">
        <label>角度:</label>
        <input type="number" id="goalTheta" step="0.1" value="1.57">
        <button onclick="sendGoal()" style="margin-left: 10px;">🚀 发送目标</button>
      </div>
      
      <div class="input-group">
        <h4>速度控制</h4>
        <label>线速度X:</label>
        <input type="number" id="velX" step="0.1" value="0.2">
        <label>线速度Y:</label>
        <input type="number" id="velY" step="0.1" value="0.0">
        <label>角速度:</label>
        <input type="number" id="velTheta" step="0.1" value="0.1">
        <button onclick="sendCmdVel()" style="margin-left: 10px;">⚡ 发送速度</button>
        <button onclick="stopMovement()">⏹️ 停止移动</button>
      </div>
      
      <div class="input-group">
        <h4>🔔 巡检回调测试</h4>
        <label>机器人ID:</label>
        <input type="number" id="callbackRobotId" value="1">
        <label>任务ID:</label>
        <input type="number" id="callbackTaskId" value="1001">
        <label>执行状态:</label>
        <select id="callbackStatus" style="margin-right: 10px;">
          <option value="SUCCEEDED">成功完成</option>
          <option value="FAILED">执行失败</option>
          <option value="success">成功(兼容)</option>
        </select>
        <button onclick="sendInspectionCallback('success')" style="margin-left: 10px;">✅ 模拟成功回调</button>
        <button onclick="sendInspectionCallback('failed')">❌ 模拟失败回调</button>
      </div>
      
      <div id="goalRange" style="margin-top: 10px; color: #7f8c8d; font-size: 12px;"></div>
    </div>

    <!-- 地图显示面板 -->
    <div class="panel full-width">
      <h3>🗺️ 环境地图</h3>
      <div class="map-container">
        <canvas id="mapCanvas" width="1000" height="600"></canvas>
      </div>
    </div>

    <!-- 状态历史面板 -->
    <div class="panel full-width">
      <h3>📊 状态历史记录</h3>
      <div class="history-log" id="historyLog">
        <div class="log-entry">
          <span class="log-timestamp">[系统]</span>
          <span>导航监控系统已启动</span>
        </div>
      </div>
      <div style="margin-top: 10px;">
        <button onclick="clearHistory()">🗑️ 清除历史</button>
        <button onclick="exportHistory()">📥 导出日志</button>
      </div>
    </div>
  </div>

  <script>
    let autoUpdateInterval = null;
    let mapData = null;
    let robotPose = {x: 0, y: 0, theta: 0};
    let navigationStatus = 'IDLE';
    let historyEntries = [];

    // 状态映射
    const statusConfig = {
      'IDLE': { class: 'status-idle', text: '空闲', color: '#95a5a6' },
      'GOING': { class: 'status-going', text: '导航中', color: '#f39c12' },
      'PAUSED': { class: 'status-paused', text: '已暂停', color: '#e67e22' },
      'SUCCEEDED': { class: 'status-succeeded', text: '成功到达', color: '#27ae60' },
      'FAILED': { class: 'status-failed', text: '导航失败', color: '#e74c3c' }
    };

    function addHistoryEntry(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = {
        timestamp: timestamp,
        message: message,
        type: type
      };
      
      historyEntries.push(entry);
      
      const logDiv = document.getElementById('historyLog');
      const entryDiv = document.createElement('div');
      entryDiv.className = 'log-entry';
      entryDiv.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span>${message}</span>`;
      
      // 根据类型设置颜色
      switch(type) {
        case 'success':
          entryDiv.style.color = '#2ecc71';
          break;
        case 'warning':
          entryDiv.style.color = '#f39c12';
          break;
        case 'error':
          entryDiv.style.color = '#e74c3c';
          break;
        default:
          entryDiv.style.color = '#ecf0f1';
      }
      
      logDiv.appendChild(entryDiv);
      logDiv.scrollTop = logDiv.scrollHeight;
      
      // 限制历史记录数量
      if (historyEntries.length > 100) {
        historyEntries.shift();
        logDiv.removeChild(logDiv.firstChild);
      }
    }

    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      
      alertContainer.appendChild(alertDiv);
      
      // 3秒后自动移除
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.parentNode.removeChild(alertDiv);
        }
      }, 3000);
    }

    function updateNavigationStatus(status) {
      navigationStatus = status;
      const config = statusConfig[status] || statusConfig['IDLE'];
      
      document.getElementById('navigationStatus').textContent = config.text;
      const indicator = document.getElementById('statusIndicator');
      indicator.className = `status-indicator ${config.class}`;
      
      // 更新按钮状态
      const pauseBtn = document.getElementById('pauseBtn');
      const resumeBtn = document.getElementById('resumeBtn');
      
      pauseBtn.disabled = (status !== 'GOING');
      resumeBtn.disabled = (status !== 'PAUSED');
      
      // 记录状态变化
      addHistoryEntry(`导航状态变更为: ${config.text}`, 'info');
      
      // 根据状态显示提示
      if (status === 'SUCCEEDED') {
        showAlert('🎉 导航任务成功完成！', 'success');
      } else if (status === 'FAILED') {
        showAlert('❌ 导航任务失败，请检查目标点或环境', 'error');
      }
    }

    function log(data) {
      // 调试日志输出到控制台
      console.log('Debug:', data);
    }

    function getMap() {
      fetch("http://localhost:8000/api/robot/map")
        .then(res => res.json())
        .then(data => {
          log(data);
          if (data.Result === 0) {
            mapData = data;
            drawMap(data);
            updateGoalRange();
            addHistoryEntry('地图数据获取成功', 'success');
          } else {
            console.error("获取地图失败:", data.Error);
            addHistoryEntry(`获取地图失败: ${data.Error}`, 'error');
          }
        })
        .catch(error => {
          console.error("请求地图失败:", error);
          addHistoryEntry(`请求地图失败: ${error.message}`, 'error');
        });
    }

    function getStatus() {
      fetch("http://localhost:8000/api/robot/status")
        .then(res => res.json())
        .then(data => {
          log(data);
          if (data.localization) {
            robotPose = {
              x: data.localization.x,
              y: data.localization.y,
              theta: data.localization.theta
            };
            
            // 更新位置显示
            document.getElementById('positionX').textContent = robotPose.x.toFixed(2);
            document.getElementById('positionY').textContent = robotPose.y.toFixed(2);
            document.getElementById('positionTheta').textContent = robotPose.theta.toFixed(2) + '°';
            
            // 更新电池显示
            if (data.battery) {
              document.getElementById('batteryLevel').textContent = data.battery.power.toFixed(1) + '%';
              document.getElementById('batteryProgress').style.width = data.battery.power + '%';
            }
            
            // 更新定位精度
            if (data.localization && data.localization.reliability) {
              document.getElementById('localizationReliability').textContent = 
                (data.localization.reliability * 100).toFixed(0) + '%';
            }
            
            if (mapData) {
              drawMap(mapData);
            }
          }
        })
        .catch(error => {
          console.error("请求状态失败:", error);
          addHistoryEntry(`请求状态失败: ${error.message}`, 'error');
        });
    }

    function getNavigationStatus() {
      fetch("http://localhost:8000/api/robot/navigation_status")
        .then(res => res.json())
        .then(data => {
          log(data);
          if (data.Result === 0) {
            updateNavigationStatus(data.status);
          } else {
            console.error("获取导航状态失败:", data.Error);
            addHistoryEntry(`获取导航状态失败: ${data.Error}`, 'error');
          }
        })
        .catch(error => {
          console.error("请求导航状态失败:", error);
          addHistoryEntry(`请求导航状态失败: ${error.message}`, 'error');
        });
    }

    function drawMap(mapInfo) {
      const canvas = document.getElementById("mapCanvas");
      if (!canvas) {
        console.error("地图画布元素不存在");
        return;
      }
      
      const ctx = canvas.getContext("2d");
      if (!ctx) {
        console.error("无法获取画布上下文");
        return;
      }
      
      console.log("开始绘制地图，尺寸:", mapInfo.width, "x", mapInfo.height);
      
      // 清空画布
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 计算缩放比例
      const scale = Math.min(canvas.width / mapInfo.width, canvas.height / mapInfo.height);
      const scaledWidth = mapInfo.width * scale;
      const scaledHeight = mapInfo.height * scale;
      const offsetX = (canvas.width - scaledWidth) / 2;
      const offsetY = (canvas.height - scaledHeight) / 2;
      
      // 解析base64数据
      try {
        const binaryString = atob(mapInfo.data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        
        console.log("地图数据解析成功，数据长度:", bytes.length);
        
        // 绘制栅格地图
        for (let y = 0; y < mapInfo.height; y++) {
          for (let x = 0; x < mapInfo.width; x++) {
            const index = y * mapInfo.width + x;
            const value = bytes[index];
            
            let color;
            if (value === -1) {
              color = "#CCCCCC"; // 未知区域
            } else if (value === 0) {
              color = "#FFFFFF"; // 空闲区域
            } else if (value === 100) {
              color = "#000000"; // 占用区域
            } else {
              const intensity = Math.floor(255 - (value * 2.55));
              color = `rgb(${intensity}, ${intensity}, ${intensity})`;
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(offsetX + x * scale, offsetY + y * scale, scale, scale);
          }
        }
        
        console.log("栅格地图绘制完成");
        
        // 绘制网格线
        ctx.strokeStyle = "#E0E0E0";
        ctx.lineWidth = 0.5;
        for (let x = 0; x <= mapInfo.width; x++) {
          ctx.beginPath();
          ctx.moveTo(offsetX + x * scale, offsetY);
          ctx.lineTo(offsetX + x * scale, offsetY + scaledHeight);
          ctx.stroke();
        }
        for (let y = 0; y <= mapInfo.height; y++) {
          ctx.beginPath();
          ctx.moveTo(offsetX, offsetY + y * scale);
          ctx.lineTo(offsetX + scaledWidth, offsetY + y * scale);
          ctx.stroke();
        }
        
        // 绘制机器人
        drawRobot(ctx, robotPose, offsetX, offsetY, scale, mapInfo);
        
        // 显示地图信息
        ctx.fillStyle = "#333";
        ctx.font = "12px Arial";
        ctx.fillText(`分辨率: ${mapInfo.resolution}m`, 10, canvas.height - 40);
        ctx.fillText(`尺寸: ${mapInfo.width}x${mapInfo.height}`, 10, canvas.height - 25);
        ctx.fillText(`原点: (${mapInfo.origin_x}, ${mapInfo.origin_y})`, 10, canvas.height - 10);
        
        console.log("地图绘制完成");
        
      } catch (error) {
        console.error("地图数据解析失败:", error);
        addHistoryEntry(`地图数据解析失败: ${error.message}`, 'error');
      }
    }

    function drawRobot(ctx, pose, offsetX, offsetY, scale, mapInfo) {
      const mapX = (pose.x - mapInfo.origin_x) / mapInfo.resolution;
      const mapY = (pose.y - mapInfo.origin_y) / mapInfo.resolution;
      const canvasX = offsetX + mapX * scale;
      const canvasY = offsetY + mapY * scale;
      
      ctx.save();
      ctx.translate(canvasX, canvasY);
      ctx.rotate(pose.theta);
      
      const size = Math.min(scale * 4, 20);
      
      // 根据导航状态设置颜色
      const config = statusConfig[navigationStatus] || statusConfig['IDLE'];
      ctx.fillStyle = config.color;
      ctx.strokeStyle = config.color;
      ctx.lineWidth = 3;
      
      ctx.beginPath();
      ctx.moveTo(size, 0);
      ctx.lineTo(-size/2, -size/2);
      ctx.lineTo(-size/2, size/2);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
      
      ctx.restore();
    }

    function updateGoalRange() {
      if (!mapData) return;
      
      const rangeDiv = document.getElementById("goalRange");
      const minX = mapData.origin_x;
      const maxX = mapData.origin_x + mapData.width * mapData.resolution;
      const minY = mapData.origin_y;
      const maxY = mapData.origin_y + mapData.height * mapData.resolution;
      
      rangeDiv.innerHTML = `目标点有效范围: X[${minX.toFixed(1)}, ${maxX.toFixed(1)}], Y[${minY.toFixed(1)}, ${maxY.toFixed(1)}]`;
      
      document.getElementById("goalX").min = minX;
      document.getElementById("goalX").max = maxX;
      document.getElementById("goalY").min = minY;
      document.getElementById("goalY").max = maxY;
    }

    function sendGoal() {
      const goalX = parseFloat(document.getElementById("goalX").value);
      const goalY = parseFloat(document.getElementById("goalY").value);
      const goalTheta = parseFloat(document.getElementById("goalTheta").value);
      
      fetch("http://localhost:8000/api/robot/navigation_goal", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          goal_id: 1,
          goal_x: goalX,
          goal_y: goalY,
          goal_theta: goalTheta,
          xy_tolerance: 0.1,
          yaw_tolerance: 0.05
        })
      }).then(res => res.json())
        .then(data => {
          if (data.Result === 0) {
            addHistoryEntry(`导航目标已发送: X=${goalX}, Y=${goalY}, θ=${goalTheta}`, 'success');
            showAlert('🎯 导航目标已发送', 'success');
          } else {
            addHistoryEntry(`导航目标发送失败: ${data.Error}`, 'error');
            showAlert('❌ 导航目标发送失败', 'error');
          }
        });
    }

    function sendCmdVel() {
      const velX = parseFloat(document.getElementById("velX").value);
      const velY = parseFloat(document.getElementById("velY").value);
      const velTheta = parseFloat(document.getElementById("velTheta").value);
      
      fetch("http://localhost:8000/api/robot/cmd_vel", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          vel_x: velX,
          vel_y: velY,
          vel_theta: velTheta
        })
      }).then(res => res.json())
        .then(data => {
          if (data.Result === 0) {
            addHistoryEntry(`速度指令已发送: vx=${velX}, vy=${velY}, vθ=${velTheta}`, 'success');
          } else {
            addHistoryEntry(`速度指令发送失败: ${data.Error}`, 'error');
          }
        });
    }

    function stopMovement() {
      fetch("http://localhost:8000/api/robot/cmd_vel", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          vel_x: 0.0,
          vel_y: 0.0,
          vel_theta: 0.0
        })
      }).then(res => res.json())
        .then(data => {
          if (data.Result === 0) {
            addHistoryEntry('机器人移动已停止', 'success');
            showAlert('⏹️ 机器人已停止移动', 'warning');
          }
        });
    }

    function pauseNavigation() {
      fetch("http://localhost:8000/api/robot/pause_navigation", {
        method: "POST"
      }).then(res => res.json())
        .then(data => {
          if (data.Result === 0) {
            addHistoryEntry('导航已暂停', 'warning');
            showAlert('⏸️ 导航已暂停', 'warning');
          } else {
            addHistoryEntry(`暂停导航失败: ${data.Error}`, 'error');
          }
        });
    }

    function resumeNavigation() {
      fetch("http://localhost:8000/api/robot/resume_navigation", {
        method: "POST"
      }).then(res => res.json())
        .then(data => {
          if (data.Result === 0) {
            addHistoryEntry('导航已恢复', 'success');
            showAlert('▶️ 导航已恢复', 'success');
          } else {
            addHistoryEntry(`恢复导航失败: ${data.Error}`, 'error');
          }
        });
    }

    function emergencyStop() {
      // 停止所有移动
      stopMovement();
      // 暂停导航
      pauseNavigation();
      addHistoryEntry('🚨 紧急停止已执行', 'error');
      showAlert('🚨 紧急停止已执行', 'error');
    }

    function startAutoUpdate() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
      }
      
      // 立即获取一次数据
      getMap();
      getStatus();
      getNavigationStatus();
      
      // 每秒更新一次状态，每5秒更新一次地图
      let mapUpdateCounter = 0;
      autoUpdateInterval = setInterval(() => {
        getStatus();
        getNavigationStatus();
        mapUpdateCounter++;
        
        // 每5次更新一次地图（减少地图更新频率）
        if (mapUpdateCounter >= 5) {
          getMap();
          mapUpdateCounter = 0;
        }
      }, 1000);
      
      addHistoryEntry('自动监控已启动', 'success');
      showAlert('🔄 自动监控已启动', 'success');
    }

    function stopAutoUpdate() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
        autoUpdateInterval = null;
        addHistoryEntry('自动监控已停止', 'warning');
        showAlert('⏹️ 自动监控已停止', 'warning');
      }
    }

    function clearHistory() {
      historyEntries = [];
      const logDiv = document.getElementById('historyLog');
      logDiv.innerHTML = `
        <div class="log-entry">
          <span class="log-timestamp">[系统]</span>
          <span>历史记录已清除</span>
        </div>
      `;
      addHistoryEntry('历史记录已清除', 'info');
    }

    function exportHistory() {
      const dataStr = JSON.stringify(historyEntries, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `navigation_history_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      
      addHistoryEntry('历史记录已导出', 'success');
    }

    // 巡检回调通知函数
    function sendInspectionCallback(statusType) {
      const robotId = document.getElementById('callbackRobotId').value;
      const taskId = document.getElementById('callbackTaskId').value;
      const statusSelect = document.getElementById('callbackStatus');
      
      // 根据按钮类型设置状态
      if (statusType === 'success') {
        statusSelect.value = 'SUCCEEDED';
      } else if (statusType === 'failed') {
        statusSelect.value = 'FAILED';
      }
      
      const executionStatus = statusSelect.value;
      const executionTime = Date.now(); // 获取当前时间戳（毫秒）
      
      const callbackData = {
        robot_id: parseInt(robotId),
        task_id: parseInt(taskId),
        execution_status: executionStatus,
        execution_time: executionTime
      };
      
      addHistoryEntry(`发送巡检回调: 机器人${robotId}, 任务${taskId}, 状态${executionStatus}`, 'info');
      
      fetch("http://localhost:8000/api/inspection/callback", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(callbackData)
      }).then(res => res.json())
        .then(data => {
          if (data.code === 200) {
            addHistoryEntry(`巡检回调发送成功: ${data.msg}`, 'success');
            showAlert(`🔔 巡检回调发送成功 - 任务${taskId}状态: ${executionStatus}`, 'success');
            
            // 如果是模拟模式，等待一段时间后获取最新的导航状态
            setTimeout(() => {
              getNavigationStatus();
            }, 1000);
          } else {
            addHistoryEntry(`巡检回调发送失败: ${data.msg}`, 'error');
            showAlert(`❌ 巡检回调发送失败: ${data.msg}`, 'error');
          }
        })
        .catch(error => {
          console.error("巡检回调请求失败:", error);
          addHistoryEntry(`巡检回调请求失败: ${error.message}`, 'error');
          showAlert(`❌ 巡检回调请求失败: ${error.message}`, 'error');
        });
    }

    // 页面加载时自动获取地图和状态
    window.onload = function() {
      console.log("页面加载完成，开始初始化...");
      getMap();
      getStatus();
      getNavigationStatus();
      
      // 自动启动监控
      setTimeout(startAutoUpdate, 1000);
    };
  </script>
</body>
</html>