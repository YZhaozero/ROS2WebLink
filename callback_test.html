<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¡æ£€å›è°ƒéªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
        }
        .section h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-group label {
            min-width: 100px;
            font-weight: bold;
        }
        .input-group input, .input-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .status-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
        }
        .status-item {
            margin-bottom: 8px;
        }
        .status-label {
            font-weight: bold;
            color: #495057;
        }
        .status-value {
            color: #007bff;
        }
        .log-container {
            background-color: #212529;
            color: #ffffff;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-timestamp {
            color: #6c757d;
        }
        .log-success {
            color: #28a745;
        }
        .log-error {
            color: #dc3545;
        }
        .log-info {
            color: #17a2b8;
        }
        .config-section {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”” å·¡æ£€å›è°ƒéªŒè¯æµ‹è¯•</h1>
    
    <!-- æœåŠ¡å™¨é…ç½® -->
    <div class="container">
        <div class="config-section">
            <h3>âš™ï¸ æœåŠ¡å™¨é…ç½®</h3>
            <div class="input-group">
                <label>æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="serverUrl" value="http://10.240.6.173:8000" placeholder="æœåŠ¡å™¨åœ°å€">
                <button class="btn btn-info" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            </div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨å›è°ƒæµ‹è¯• -->
    <div class="container">
        <div class="section">
            <h3>ğŸ“ æ‰‹åŠ¨å›è°ƒæµ‹è¯•</h3>
            <div class="input-group">
                <label>æœºå™¨äººID:</label>
                <input type="number" id="manualRobotId" value="1" placeholder="æœºå™¨äººID">
            </div>
            <div class="input-group">
                <label>ä»»åŠ¡ID:</label>
                <input type="number" id="manualTaskId" value="1001" placeholder="ä»»åŠ¡ID">
            </div>
            <div class="input-group">
                <label>æ‰§è¡ŒçŠ¶æ€:</label>
                <select id="manualStatus">
                    <option value="SUCCEEDED">æˆåŠŸå®Œæˆ (SUCCEEDED)</option>
                    <option value="FAILED">æ‰§è¡Œå¤±è´¥ (FAILED)</option>
                    <option value="success">æˆåŠŸ (success)</option>
                </select>
            </div>
            <div class="input-group">
                <button class="btn btn-success" onclick="sendManualCallback('SUCCEEDED')">âœ… å‘é€æˆåŠŸå›è°ƒ</button>
                <button class="btn btn-danger" onclick="sendManualCallback('FAILED')">âŒ å‘é€å¤±è´¥å›è°ƒ</button>
                <button class="btn btn-info" onclick="sendManualCallback()">ğŸ“¤ å‘é€è‡ªå®šä¹‰å›è°ƒ</button>
            </div>
        </div>
    </div>

    <!-- ROSçŠ¶æ€ç›‘å¬æµ‹è¯• -->
    <div class="container">
        <div class="section">
            <h3>ğŸ¤– ROSçŠ¶æ€ç›‘å¬æµ‹è¯•</h3>
            <div class="input-group">
                <button class="btn btn-info" onclick="getNavStatus()">ğŸ”„ è·å–å¯¼èˆªçŠ¶æ€</button>
                <button class="btn btn-success" onclick="startAutoMonitoring()">â–¶ï¸ å¼€å§‹è‡ªåŠ¨ç›‘å¬</button>
                <button class="btn btn-warning" onclick="stopAutoMonitoring()">â¹ï¸ åœæ­¢è‡ªåŠ¨ç›‘å¬</button>
                <button class="btn btn-info" onclick="triggerAutoCallback()">ğŸš€ è§¦å‘è‡ªåŠ¨å›è°ƒ</button>
            </div>
            
            <div class="status-display">
                <div class="status-item">
                    <span class="status-label">å½“å‰å¯¼èˆªçŠ¶æ€:</span>
                    <span class="status-value" id="currentNavStatus">æœªçŸ¥</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æ˜¯å¦å¯è§¦å‘å›è°ƒ:</span>
                    <span class="status-value" id="canTriggerCallback">æœªçŸ¥</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æœ€åæ›´æ–°æ—¶é—´:</span>
                    <span class="status-value" id="lastUpdateTime">æœªæ›´æ–°</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ç›‘å¬çŠ¶æ€:</span>
                    <span class="status-value" id="monitoringStatus">å·²åœæ­¢</span>
                </div>
            </div>
        </div>
    </div>

    <!-- å›è°ƒå“åº”æ˜¾ç¤º -->
    <div class="container">
        <div class="section">
            <h3>ğŸ“Š å›è°ƒå“åº”æ˜¾ç¤º</h3>
            <div class="status-display">
                <div class="status-item">
                    <span class="status-label">å“åº”ç :</span>
                    <span class="status-value" id="responseCode">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å“åº”æ¶ˆæ¯:</span>
                    <span class="status-value" id="responseMessage">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å“åº”æ—¶é—´:</span>
                    <span class="status-value" id="responseTime">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å®Œæ•´å“åº”:</span>
                    <pre id="fullResponse" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px;">-</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥å¿—æ˜¾ç¤º -->
    <div class="container">
        <div class="section">
            <h3>ğŸ“‹ æ“ä½œæ—¥å¿—</h3>
            <button class="btn btn-warning" onclick="clearLog()" style="margin-bottom: 10px;">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
            <div class="log-container" id="logContainer">
                <div class="log-entry">
                    <span class="log-timestamp">[ç³»ç»Ÿ]</span>
                    <span>å·¡æ£€å›è°ƒéªŒè¯æµ‹è¯•é¡µé¢å·²åŠ è½½</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let monitoringInterval = null;
        const serverUrlInput = document.getElementById('serverUrl');

        // è·å–æœåŠ¡å™¨URL
        function getServerUrl() {
            return serverUrlInput.value.trim();
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span>${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">[ç³»ç»Ÿ]</span>
                    <span>æ—¥å¿—å·²æ¸…é™¤</span>
                </div>
            `;
        }

        // æµ‹è¯•è¿æ¥
        function testConnection() {
            const url = getServerUrl();
            addLog(`æ­£åœ¨æµ‹è¯•æœåŠ¡å™¨è¿æ¥: ${url}`, 'info');
            
            fetch(`${url}/api/robot/status`)
                .then(response => response.json())
                .then(data => {
                    if (data.Result === 0) {
                        addLog(`âœ… æœåŠ¡å™¨è¿æ¥æˆåŠŸ`, 'success');
                        showAlert('æœåŠ¡å™¨è¿æ¥æˆåŠŸ', 'success');
                    } else {
                        addLog(`âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${data.Error}`, 'error');
                        showAlert('æœåŠ¡å™¨è¿æ¥å¤±è´¥', 'error');
                    }
                })
                .catch(error => {
                    addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    showAlert('è¿æ¥å¤±è´¥', 'error');
                });
        }

        // å‘é€æ‰‹åŠ¨å›è°ƒ
        function sendManualCallback(statusType = null) {
            const robotId = document.getElementById('manualRobotId').value;
            const taskId = document.getElementById('manualTaskId').value;
            const statusSelect = document.getElementById('manualStatus');
            
            // æ ¹æ®æŒ‰é’®ç±»å‹è®¾ç½®çŠ¶æ€
            if (statusType === 'SUCCEEDED') {
                statusSelect.value = 'SUCCEEDED';
            } else if (statusType === 'FAILED') {
                statusSelect.value = 'FAILED';
            }
            
            const executionStatus = statusSelect.value;
            const executionTime = Date.now();
            
            const callbackData = {
                robot_id: parseInt(robotId),
                task_id: parseInt(taskId),
                execution_status: executionStatus,
                execution_time: executionTime
            };
            
            addLog(`å‘é€æ‰‹åŠ¨å›è°ƒ: æœºå™¨äºº${robotId}, ä»»åŠ¡${taskId}, çŠ¶æ€${executionStatus}`, 'info');
            
            sendCallbackRequest(callbackData);
        }

        // è·å–å¯¼èˆªçŠ¶æ€
        function getNavStatus() {
            const url = getServerUrl();
            addLog('æ­£åœ¨è·å–å¯¼èˆªçŠ¶æ€...', 'info');
            
            fetch(`${url}/api/inspection/nav_status`)
                .then(response => response.json())
                .then(data => {
                    updateNavStatusDisplay(data);
                    if (data.code === 200) {
                        addLog(`âœ… è·å–å¯¼èˆªçŠ¶æ€æˆåŠŸ: ${data.nav_status}`, 'success');
                    } else {
                        addLog(`âŒ è·å–å¯¼èˆªçŠ¶æ€å¤±è´¥: ${data.msg}`, 'error');
                    }
                })
                .catch(error => {
                    addLog(`âŒ è·å–å¯¼èˆªçŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
                });
        }

        // è§¦å‘è‡ªåŠ¨å›è°ƒ
        function triggerAutoCallback() {
            const url = getServerUrl();
            addLog('æ­£åœ¨è§¦å‘è‡ªåŠ¨å›è°ƒ...', 'info');
            
            fetch(`${url}/api/inspection/callback`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
                .then(response => response.json())
                .then(data => {
                    updateResponseDisplay(data);
                    if (data.code === 200) {
                        addLog(`âœ… è‡ªåŠ¨å›è°ƒè§¦å‘æˆåŠŸ`, 'success');
                    } else {
                        addLog(`âŒ è‡ªåŠ¨å›è°ƒè§¦å‘å¤±è´¥: ${data.msg}`, 'error');
                    }
                })
                .catch(error => {
                    addLog(`âŒ è‡ªåŠ¨å›è°ƒè§¦å‘å¤±è´¥: ${error.message}`, 'error');
                });
        }

        // å¼€å§‹è‡ªåŠ¨ç›‘å¬
        function startAutoMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            monitoringInterval = setInterval(() => {
                getNavStatus();
            }, 3000); // æ¯3ç§’æ›´æ–°ä¸€æ¬¡
            
            document.getElementById('monitoringStatus').textContent = 'è¿è¡Œä¸­';
            document.getElementById('monitoringStatus').style.color = '#28a745';
            addLog('â–¶ï¸ è‡ªåŠ¨ç›‘å¬å·²å¯åŠ¨', 'success');
        }

        // åœæ­¢è‡ªåŠ¨ç›‘å¬
        function stopAutoMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            document.getElementById('monitoringStatus').textContent = 'å·²åœæ­¢';
            document.getElementById('monitoringStatus').style.color = '#dc3545';
            addLog('â¹ï¸ è‡ªåŠ¨ç›‘å¬å·²åœæ­¢', 'warning');
        }

        // å‘é€å›è°ƒè¯·æ±‚
        function sendCallbackRequest(callbackData) {
            const url = getServerUrl();
            const startTime = Date.now();
            
            fetch(`${url}/api/inspection/callback`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(callbackData)
            })
                .then(response => response.json())
                .then(data => {
                    const responseTime = Date.now() - startTime;
                    updateResponseDisplay(data, responseTime);
                    
                    if (data.code === 200) {
                        addLog(`âœ… å›è°ƒå‘é€æˆåŠŸ: ${data.msg}`, 'success');
                        showAlert('å›è°ƒå‘é€æˆåŠŸ', 'success');
                    } else {
                        addLog(`âŒ å›è°ƒå‘é€å¤±è´¥: ${data.msg}`, 'error');
                        showAlert('å›è°ƒå‘é€å¤±è´¥', 'error');
                    }
                })
                .catch(error => {
                    addLog(`âŒ å›è°ƒå‘é€å¤±è´¥: ${error.message}`, 'error');
                    showAlert('å›è°ƒå‘é€å¤±è´¥', 'error');
                });
        }

        // æ›´æ–°å¯¼èˆªçŠ¶æ€æ˜¾ç¤º
        function updateNavStatusDisplay(data) {
            document.getElementById('currentNavStatus').textContent = data.nav_status || 'æœªçŸ¥';
            document.getElementById('canTriggerCallback').textContent = data.can_trigger_callback ? 'æ˜¯' : 'å¦';
            document.getElementById('canTriggerCallback').style.color = data.can_trigger_callback ? '#28a745' : '#dc3545';
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
        }

        // æ›´æ–°å“åº”æ˜¾ç¤º
        function updateResponseDisplay(data, responseTime = null) {
            document.getElementById('responseCode').textContent = data.code;
            document.getElementById('responseCode').style.color = data.code === 200 ? '#28a745' : '#dc3545';
            document.getElementById('responseMessage').textContent = data.msg;
            document.getElementById('responseTime').textContent = responseTime ? `${responseTime}ms` : '-';
            document.getElementById('fullResponse').textContent = JSON.stringify(data, null, 2);
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            // ç®€å•çš„æç¤ºå®ç°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 4px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                background-color: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            addLog('ğŸ”” å·¡æ£€å›è°ƒéªŒè¯æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            // è‡ªåŠ¨æµ‹è¯•è¿æ¥
            setTimeout(testConnection, 1000);
        };
    </script>
</body>
</html>