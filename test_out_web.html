<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Robot Web Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .controls {
      margin-bottom: 20px;
    }
    button {
      margin: 5px;
      padding: 8px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .map-container {
      margin: 20px 0;
      border: 2px solid #ccc;
      display: inline-block;
    }
    canvas {
      display: block;
    }
    .output-container {
      margin-top: 20px;
    }
    pre {
      background-color: #f8f9fa;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Robot Web Interface</h1>
  <div class="controls">
    <button onclick="getMap()">获取地图</button>
    <button onclick="getStatus()">获取状态</button>
    <button onclick="sendGoal()">发送导航目标</button>
    <button onclick="sendCmdVel()">发送速度指令</button>
    <button onclick="startAutoUpdate()">开始自动更新</button>
    <button onclick="stopAutoUpdate()">停止自动更新</button>
  </div>
  <div class="map-container">
    <h3>栅格地图</h3>
    <canvas id="mapCanvas" width="600" height="400"></canvas>
  </div>

  <div class="output-container">
    <h3>输出信息</h3>
    <pre id="output"></pre>
  </div>

  <script>
    let autoUpdateInterval = null;
    let mapData = null;
    function log(data) {
      document.getElementById("output").innerText = JSON.stringify(data, null, 2);
    }

    function getMap() {
      fetch("http://1jl14550ma329.vicp.fun/api/robot/map")
        .then(res => res.json())
         .then(data => {
          log(data);
          if (data.Result === 0) {
            mapData = data;
            drawMap(data);
          } else {
            console.error("获取地图失败:", data.Error);
          }
        })
        .catch(error => {
          console.error("请求地图失败:", error);
          log({error: "请求地图失败: " + error.message});
        });
    }

    function drawMap(mapInfo) {
      const canvas = document.getElementById("mapCanvas");
      const ctx = canvas.getContext("2d");
      
      // 清空画布
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 计算缩放比例
      const scale = Math.min(canvas.width / mapInfo.width, canvas.height / mapInfo.height);
      const scaledWidth = mapInfo.width * scale;
      const scaledHeight = mapInfo.height * scale;
      
      // 居中显示
      const offsetX = (canvas.width - scaledWidth) / 2;
      const offsetY = (canvas.height - scaledHeight) / 2;
      
      // 解析base64数据
      const binaryString = atob(mapInfo.data);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      
      // 绘制栅格地图
      for (let y = 0; y < mapInfo.height; y++) {
        for (let x = 0; x < mapInfo.width; x++) {
          const index = y * mapInfo.width + x;
          const value = bytes[index];
          
          // 根据栅格值设置颜色
          let color;
          if (value === -1) {
            // 未知区域 - 浅灰色
            color = "#CCCCCC";
          } else if (value === 0) {
            // 空闲区域 - 白色
            color = "#FFFFFF";
          } else if (value === 100) {
            // 占用区域 - 黑色
            color = "#000000";
          } else {
            // 部分占用 - 灰色渐变
            const intensity = Math.floor(255 - (value * 2.55));
            color = `rgb(${intensity}, ${intensity}, ${intensity})`;
          }
          
          ctx.fillStyle = color;
          ctx.fillRect(
            offsetX + x * scale,
            offsetY + y * scale,
            scale,
            scale
          );
        }
      }
      
      ctx.strokeStyle = "#E0E0E0";
      ctx.lineWidth = 0.5;
      for (let x = 0; x <= mapInfo.width; x++) {
        ctx.beginPath();
        ctx.moveTo(offsetX + x * scale, offsetY);
        ctx.lineTo(offsetX + x * scale, offsetY + scaledHeight);
        ctx.stroke();
      }
      for (let y = 0; y <= mapInfo.height; y++) {
        ctx.beginPath();
        ctx.moveTo(offsetX, offsetY + y * scale);
        ctx.lineTo(offsetX + scaledWidth, offsetY + y * scale);
        ctx.stroke();
      }
      
      // 显示地图信息
      ctx.fillStyle = "#333";
      ctx.font = "12px Arial";
      ctx.fillText(`分辨率: ${mapInfo.resolution}m`, 10, canvas.height - 40);
      ctx.fillText(`尺寸: ${mapInfo.width}x${mapInfo.height}`, 10, canvas.height - 25);
      ctx.fillText(`原点: (${mapInfo.origin_x}, ${mapInfo.origin_y})`, 10, canvas.height - 10);
    }

    function getStatus() {
      fetch("http://1jl14550ma329.vicp.fun/api/robot/status")
        .then(res => res.json())
        .then(data => log(data));
    }

    function sendGoal() {
      fetch("http://1jl14550ma329.vicp.fun/api/robot/navigation_goal", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          goal_id: 1,
          goal_x: 5.0,
          goal_y: 3.0,
          goal_theta: 1.57,
          xy_tolerance: 0.1,
          yaw_tolerance: 0.05
        })
      }).then(res => res.json())
        .then(data => log(data));
    }

    function sendCmdVel() {
      fetch("http://1jl14550ma329.vicp.fun/api/robot/cmd_vel", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          vel_x: 0.2,
          vel_y: 0.0,
          vel_theta: 0.1
        })
      }).then(res => res.json())
        .then(data => log(data));
    }

    function startAutoUpdate() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
      }
      
      // 立即获取一次地图
      getMap();
      
      // 每2秒更新一次地图
      autoUpdateInterval = setInterval(() => {
        getMap();
      }, 2000);
      
      log({status: "自动更新已启动"});
    }

    function stopAutoUpdate() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
        autoUpdateInterval = null;
        log({status: "自动更新已停止"});
      }
    }

    // 页面加载时自动获取地图
    window.onload = function() {
      getMap();
    };
  </script>
</body>
</html>